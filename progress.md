# 进度日志

## 2026-02-18
- 完成 OpenSpec 与技能流程检查。
- 完成核心模块定位与首轮代码阅读。
- 已创建计划与发现文件，进入注释实施阶段。
- 已完成以下核心文件中文注释增强：
  - `src/services/trading-service.ts`
  - `src/services/market-service.ts`
  - `src/services/smart-money-service.ts`
  - `src/services/copy-trading-execution-service.ts`
  - `src/core/tx-mutex.ts`
  - `src/core/tx-monitor.ts`
- 已执行 `pnpm run build`，TypeScript 编译通过。
- 第二批已完成以下文件中文注释增强：
  - `scripts/copy-trading-worker.ts`
  - `web/app/api/copy-trading/execute/route.ts`
  - `web/app/api/copy-trading/config/route.ts`
  - `web/app/api/copy-trading/detect/route.ts`
  - `web/app/api/copy-trading/readiness/route.ts`
- 已执行 `web` lint：失败（仓库已有大量历史 lint 问题，非本次注释改动引入）。
- 第三批已完成以下文件中文注释增强：
  - `web/app/api/copy-trading/orders/route.ts`
  - `web/app/api/copy-trading/positions/route.ts`
  - `web/app/api/copy-trading/metrics/route.ts`
  - `web/lib/services/guardrail-service.ts`
  - `web/scripts/copy-trading-supervisor.ts`
- 已再次执行 `pnpm run build`，TypeScript 编译通过。
- 第四批已完成以下文件中文注释增强：
  - `web/scripts/copy-trading-supervisor.ts`（配置区分组注释增强）
  - `scripts/copy-trading-worker.ts`（配置区分组注释增强）
  - `src/services/smart-money-service.ts`（候选筛选与评分口径注释增强）
- 已再次执行 `pnpm run build`，TypeScript 编译通过。
- 第五批已完成以下文件中文注释增强：
  - `src/services/trading-service.ts`（订单管理/奖励/授权细节注释增强）
  - `src/services/market-service.ts`（信号检测与归一化流程注释增强）
  - `src/services/copy-trading-execution-service.ts`（动态滑点模型注释增强）
  - `src/core/tx-mutex.ts`（队列与观测语义注释增强）
  - `src/core/tx-monitor.ts`（跟踪与替换链路注释增强）
- 已再次执行 `pnpm run build`，TypeScript 编译通过。
- 第六批已完成以下文件中文注释增强：
  - `src/services/trading-service.ts`（初始化/缓存/本地模式注释增强）
  - `src/services/market-service.ts`（初始化/重试/历史解析入口注释增强）
  - `src/services/copy-trading-execution-service.ts`（地址路由/守卫入口注释增强）
  - `src/core/tx-mutex.ts`（isLocked 使用语义注释增强）
  - `src/core/tx-monitor.ts`（confirm 语义注释增强）
- 已再次执行 `pnpm run build`，TypeScript 编译通过。

## 2026-02-19
- 第七批已完成以下文件中文注释增强：
  - `web/app/api/copy-trading/readiness/route.ts`（RPC 选择、降级容错、动作阈值口径注释增强）
  - `src/services/market-service.ts`（历史/实时 spread 语义边界与信号阈值注释增强）
  - `src/services/copy-trading-execution-service.ts`（Executor 代理执行、锁分层、AUTO 滑点与结算 fallback 注释增强）
- 已执行 `pnpm run build`，TypeScript 编译通过。

## 2026-02-24
- 新增 Supervisor 分片模式 Redis 强依赖：当 `SUPERVISOR_SHARD_COUNT>1` 时，缺少 `REDIS_URL` 将启动失败（fail fast）。
- 新增 Supervisor 分片模式 Redis 连通性强校验：Redis 初始化/PING 失败将启动失败（fail fast），不再回退内存队列/去重/计数。
- 保持单实例模式（`SUPERVISOR_SHARD_COUNT<=1`）兼容：Redis 不可用时仍允许内存回退。
- 新增 OpenSpec 变更：`enforce-redis-sharded-supervisor`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate enforce-redis-sharded-supervisor --strict --no-interactive`，通过。
- 新增 EOA 执行服务缓存生命周期加固：`UserExecutionManager` 支持 `SUPERVISOR_EOA_SERVICE_TTL_MS` 与周期 sweep（`SUPERVISOR_EOA_SERVICE_SWEEP_INTERVAL_MS`），超时自动驱逐。
- 新增 EOA 缓存命中续期机制：每次复用服务都会刷新 `lastAccessAt`。
- 新增优雅退出清理：`SIGINT/SIGTERM` 走 `shutdown()`，退出前清空 EOA 缓存。
- 新增 OpenSpec 变更：`harden-eoa-service-cache-lifecycle`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate harden-eoa-service-cache-lifecycle --strict --no-interactive`，通过。
- 新增 Supervisor 运维级 SLO 观测：队列 `p95` lag、reject reason 分布、per-wallet success/fail/skip、reconcile 差额汇总。
- 新增执行结果统一记账：`success/failed/skipped` 在执行主路径统一打点，避免仅统计失败导致的成功率失真。
- 新增 OpenSpec 变更：`add-supervisor-operational-slo-metrics`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-operational-slo-metrics --strict --no-interactive`，通过。
- 新增 Supervisor 自动降载（load shedding）状态机：`NORMAL/DEGRADED/CRITICAL`，基于队列深度与队列 p95 lag 阈值自动切换。
- 新增动态 fanout 并发上限：高负载自动降低订阅分发并发，恢复后自动回升（带恢复窗口 hysteresis）。
- 新增 mempool 自动暂停闸门：降载模式下暂停 mempool dispatch，避免拥塞扩大。
- 修复/接通 mempool 回调：`MempoolDetector` 回调已接入 `handleSniffedTx` 执行链路。
- 新增 OpenSpec 变更：`add-supervisor-auto-load-shedding`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-auto-load-shedding --strict --no-interactive`，通过。
- 新增 Supervisor 内置指标服务：支持 `/metrics`（Prometheus 文本格式）与 `/health`/`/healthz`。
- 新增累计型观测计数器：执行结果、队列动作、拒单原因、reconcile 差额、告警次数等，避免仅窗口统计导致趋势不可见。
- 新增运行时阈值告警：队列深度、队列 p95 lag、reject rate、`CRITICAL` 降载模式触发告警，并有冷却时间防止刷屏。
- 指标服务已接入启动与优雅退出生命周期（start/shutdown）。
- 新增 OpenSpec 变更：`add-supervisor-metrics-endpoint-alerts`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-metrics-endpoint-alerts --strict --no-interactive`，通过。
- 新增 Stage1 监控落地模板：`deploy/stage1/monitoring/prometheus/prometheus.supervisor.yml`（Prometheus scrape）与 `deploy/stage1/monitoring/grafana/dashboards/copy-trading-supervisor.json`（Grafana dashboard）。
- 新增监控落地文档：`deploy/stage1/monitoring/README.md` 与 `docs/operations/deploy-supervisor-monitoring.md`，并更新 `deploy/stage1/README.md`、`docs/operations/README.md` 索引入口。
- 新增 OpenSpec 变更：`add-supervisor-monitoring-templates`（proposal/tasks/spec delta）。
- 已执行 `jq empty deploy/stage1/monitoring/grafana/dashboards/copy-trading-supervisor.json`，通过。
- 已执行 `openspec validate add-supervisor-monitoring-templates --strict --no-interactive`，通过。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 新增 `SETTLEMENT_PENDING` 自动恢复闭环：Supervisor 增加抢锁扫描 + `recoverSettlement` 执行 + 指数退避重试 + 超限失败落库（避免无限 pending）。
- 新增 Settlement Recovery 指标：Prometheus 暴露 `copy_supervisor_settlement_recovery_*`（runs/recovered/failed/exhausted/window）。
- 新增恢复循环配置：`SUPERVISOR_SETTLEMENT_RECOVERY_*`、`COPY_TRADING_SETTLEMENT_*`、`COPY_TRADING_LOCK_TTL_MS`。
- 新增 OpenSpec 变更：`add-supervisor-settlement-recovery-loop`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-settlement-recovery-loop --strict --no-interactive`，通过。
- 新增 Supervisor 队列 ack/reclaim 语义：`claim/ack/nack` + processing lease + stale reclaim，避免“出队后进程崩溃”导致任务丢失。
- Redis 队列新增 processing/inflight 结构；内存队列补齐 in-flight 回收语义，行为对齐。
- 新增队列恢复指标：`copy_supervisor_queue_total{action="reclaimed"}` 与摘要日志 `reclaimed` 统计。
- 新增 OpenSpec 变更：`add-supervisor-queue-ack-reclaim`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-queue-ack-reclaim --strict --no-interactive`，通过。
- 新增 Supervisor 队列投递上限与 DLQ：`SUPERVISOR_QUEUE_MAX_ATTEMPTS`、`SUPERVISOR_QUEUE_DLQ_MAX_SIZE`，超限任务进入 dead-letter，不再无限回队。
- 新增 Queue DLQ 观测：`copy_supervisor_queue_total{action="dead_lettered"}`、`copy_supervisor_queue_dlq_size`，并接入 `SUPERVISOR_ALERT_QUEUE_DLQ_SIZE` 告警阈值。
- 新增 OpenSpec 变更：`add-supervisor-queue-dlq-attempt-limits`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-queue-dlq-attempt-limits --strict --no-interactive`，通过。
- 新增 DLQ 运维工具脚本：`web/scripts/verify/supervisor-dlq-ops.ts`，支持 `stats/peek/replay/purge`、过滤参数与 `--dry-run`。
- 新增 DLQ 运维 SOP：`docs/operations/sop-supervisor-dlq.md`，并在 `docs/operations/README.md` 增加入口。
- 新增 OpenSpec 变更：`add-supervisor-dlq-ops-tool`（proposal/tasks/spec delta）。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `openspec validate add-supervisor-dlq-ops-tool --strict --no-interactive`，通过。

## 2026-02-25
- 完成市场部门“参与机制与全球合伙人计划”需求结构化整理。
- 完成现有实现盘点（`managed-membership`、`managed-subscriptions`、`affiliate-engine`、Prisma 模型、验证脚本）。
- 识别复用项：88/228 订阅费、MCN 5折、1天试用、直推一次 +1 天奖励。
- 识别缺口：双入金通道、FREE/MANAGED 门槛、V1-V9 净入金等级、平级奖、全球合伙人席位机制。
- 新增 OpenSpec 变更：`add-horus-participation-partner-program`（proposal/tasks/design/spec deltas）。
- 已执行 `openspec validate add-horus-participation-partner-program --strict --no-interactive`，通过。
- 基于用户“继续”指令，新增排期化路线图：`openspec/changes/add-horus-participation-partner-program/roadmap.md`。
- 完成 M1/M2/M3 映射：范围、交付、预估人天、关键依赖、发布闸门（Gate A/B/C）。
- 增加可执行假设（exchange webhook、trial计费边界、partner月结时区）以便研发先行。
- 进入 M1 开发实施：新增 Participation Program 数据模型（参与账户/入金记录/净入金账本/日等级快照/收益矩阵）并新增迁移 `20260225162000_add_participation_program_m1`。
- 新增参与机制 API：`/api/participation/rules`、`/api/participation/account`、`/api/participation/funding`。
- 托管订阅入口新增最小本金限制：默认最小 500（`PARTICIPATION_MANAGED_MIN_PRINCIPAL_USD`）；新增可选激活闸门开关 `PARTICIPATION_REQUIRE_MANAGED_ACTIVATION`。
- 将 `AffiliateEngine` 盈利收费率切换为固定 20%（统一 FREE/MANAGED 口径）。
- 新增收益矩阵种子脚本：`web/prisma/seed-participation-program.ts`（npm script: `seed:participation-program`）。
- 已执行 `cd web && npx prisma generate`，通过。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npm run test:managed-wealth:unit`，通过（6/6）。
- M1 第二批：新增托管授权留痕模型与迁移 `20260225170000_add_managed_custody_authorization`。
- 新增托管授权 API：`/api/participation/custody-auth`（查询/授权/撤销）。
- 托管订阅入口新增可选托管授权校验开关：`PARTICIPATION_REQUIRE_CUSTODY_AUTH`。
- 管理产品可选期限已收敛到 `1/7/30/90/180/360`（列表与详情 API 统一过滤）。
- `seed-managed-wealth` 与参与周期常量对齐，仅生成正式周期。
- 已执行 `cd web && npx prisma generate`，通过。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npm run test:managed-wealth:unit`，通过（6/6）。
- M2 第一批：新增 V1-V9 等级规则与分红映射（`web/lib/participation-program/levels.ts`）。
- 新增等级进度 API：`GET /api/participation/levels`（用户签名查询当前等级与下一等级差额）。
- 新增等级快照执行 API：`POST /api/participation/levels`（管理员触发，支持 dry-run，写入 `DailyLevelSnapshot`）。
- 新增等级引擎单测：`web/lib/participation-program/levels.test.ts`。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run --config vitest.config.ts lib/managed-wealth/settlement-math.test.ts lib/participation-program/levels.test.ts`，通过（13/13）。
- M2 第二批：新增平级奖结算账本模型 `SameLevelBonusSettlement` 与迁移 `20260225174000_add_same_level_bonus_settlement`。
- `AffiliateEngine.distributeProfitFee` 已接入可选平级奖链路（`PARTICIPATION_ENABLE_SAME_LEVEL_BONUS=true` 启用）：一代 4%，二代 1%，并通过唯一键实现幂等防重。
- 新增平级奖规则单测：`web/lib/participation-program/bonuses.test.ts`。
- 已执行 `cd web && npx prisma generate`，通过。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run --config vitest.config.ts lib/managed-wealth/settlement-math.test.ts lib/participation-program/levels.test.ts lib/participation-program/bonuses.test.ts`，通过（18/18）。
- M2 第三批：新增双区晋升快照模型 `DoubleZoneSnapshot` 与迁移 `20260225182000_add_double_zone_snapshot`。
- 新增双区晋升规则计算与进度构建：`web/lib/participation-program/promotion.ts`。
- 新增双区晋升 API：`GET /api/participation/promotion`、`POST /api/participation/promotion`（admin + dry-run）。
- 新增双区晋升单测：`web/lib/participation-program/promotion.test.ts`。
- 已执行 `cd web && npx prisma generate`，通过。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run --config vitest.config.ts lib/managed-wealth/settlement-math.test.ts lib/participation-program/levels.test.ts lib/participation-program/bonuses.test.ts lib/participation-program/promotion.test.ts`，通过（21/21）。
- M3 第一批：新增全球合伙人模型与迁移 `20260225191000_add_global_partner_program`（配置、席位、月榜、淘汰、退款）。
- 新增合伙人 API：
  - `GET/POST /api/partners/config`
  - `GET/POST /api/partners/seats`
  - `GET/POST /api/partners/cycle/eliminate`
  - `GET/POST /api/partners/refunds`
  - `GET/POST /api/partners/privileges`
  - `GET /api/partners/rankings`
- 新增合伙人工具能力：
  - `web/lib/participation-program/partner-program.ts`（月度键、退款截止、席位评分、排名、权限映射）
  - `web/lib/participation-program/partner-program.test.ts`
- 风险修复：增加“同月淘汰重复执行”拦截，避免重复运行导致超额淘汰。
- 已执行 `cd web && npx prisma generate`，通过。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run lib/participation-program/levels.test.ts lib/participation-program/bonuses.test.ts lib/participation-program/promotion.test.ts lib/participation-program/partner-program.test.ts`，通过（22/22）。
- 已执行 `openspec validate add-horus-participation-partner-program --strict --no-interactive`，通过。
- M1/M2 补强：新增推荐奖励共享引擎 `web/lib/participation-program/referral-subscription-bonus.ts`，将“首次合格参与 +1 天”逻辑统一到参与激活与托管订阅入口。
- `POST /api/participation/account`（ACTIVATE）已接入推荐奖励链路，返回 `marketing.referralBonusApplied`。
- `POST /api/managed-subscriptions` 改为复用推荐奖励共享引擎，去除重复逻辑并保持一次性幂等标记。
- 托管提现结算 `POST /api/managed-subscriptions/[id]/withdraw` 已接入盈利费分发触发（仅 `grossPnl > 0`），分发失败仅记录日志不阻塞提现。
- 新增单测：
  - `web/lib/participation-program/referral-subscription-bonus.test.ts`
  - `web/lib/managed-wealth/membership-plans.test.ts`
  - `web/lib/services/affiliate-engine.test.ts`
  - `web/lib/participation-program/levels-aggregation.test.ts`
- Vitest 配置补齐别名解析：`web/vitest.config.ts` 新增 `@` -> `web/` alias，避免服务层测试导入失败。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run lib/participation-program/levels-aggregation.test.ts lib/participation-program/referral-subscription-bonus.test.ts lib/managed-wealth/membership-plans.test.ts lib/services/affiliate-engine.test.ts lib/participation-program/levels.test.ts lib/participation-program/bonuses.test.ts lib/participation-program/promotion.test.ts lib/participation-program/partner-program.test.ts`，通过（35/35）。
- M1/M2 补强第二批：
  - 新增会员单活跃并发保护：`POST /api/managed-membership` 使用 `managed_membership_<wallet>` 事务锁，防止并发重复创建活跃会员。
  - 新增新人试用策略 helper：`web/lib/managed-wealth/subscription-trial.ts`，并在 `POST /api/managed-subscriptions` 复用。
  - 新增试用策略单测：`web/lib/managed-wealth/subscription-trial.test.ts`。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run lib/managed-wealth/subscription-trial.test.ts lib/managed-wealth/membership-plans.test.ts lib/participation-program/referral-subscription-bonus.test.ts lib/services/affiliate-engine.test.ts lib/participation-program/levels-aggregation.test.ts lib/participation-program/levels.test.ts lib/participation-program/bonuses.test.ts lib/participation-program/promotion.test.ts lib/participation-program/partner-program.test.ts`，通过（38/38）。
- 运维交付：新增全球合伙人 runbook `docs/operations/runbook-partner-program.md`（月度淘汰节奏、退款 SLA、补位流程、常见事故处理）。
- 更新 `docs/operations/README.md` 索引入口，增加 Global Partner monthly operations。
- OpenSpec 任务更新：`8.5` 标记完成。
- 策略一致性（3.1）补齐：
  - 新增策略解析/标签函数：`web/lib/participation-program/rules.ts`（`parseParticipationStrategy` + `PARTICIPATION_STRATEGY_LABEL_KEYS`）。
  - 新增 managed-wealth 共享策略主题：`web/lib/managed-wealth/strategy-theme.ts`。
  - API 收敛：`GET /api/managed-products` 复用统一策略解析；`GET /api/participation/rules` 新增 `strategyOptions`。
  - UI 收敛：`managed-product-card`、`subscription-modal`、`managed-wealth/page`、`proxy/strategy-selector`、`copy-trader-modal` 复用统一策略常量。
  - 新增单测：`web/lib/participation-program/rules.test.ts`、`web/lib/managed-wealth/strategy-theme.test.ts`。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run ...`（本批相关 43/43），通过。
- 7.4 后台页交付：
  - 新增 `web/app/[locale]/dashboard/admin/partners/page.tsx`，支持合伙人配置、淘汰 dry-run/执行、退款队列处理、席位快照查看。
  - 更新 `web/app/[locale]/dashboard/admin/page.tsx`，新增 `Partners Ops` 入口。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run lib/participation-program/rules.test.ts lib/managed-wealth/strategy-theme.test.ts`，通过（5/5）。
- 7.3 正式外宣规则展示交付：
  - 新增 `web/components/participation/managed-external-rules-section.tsx`，集中展示参与通道、门槛、周期、费率、安全边界与托管收益矩阵（A/B/C）。
  - 新增 `web/components/participation/affiliate-external-rules-section.tsx`，集中展示直推奖励、净入金口径、V1-V9 分红表、平级奖与全球合伙人席位规则。
  - `web/app/[locale]/managed-wealth/page.tsx` 接入正式规则区块，面向托管理财用户展示完整外宣口径。
  - `web/app/[locale]/affiliate/rules/page.tsx` 接入正式规则区块，面向推广侧展示统一政策口径。
- OpenSpec 任务更新：`7.3` 标记完成。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run --config vitest.config.ts lib/participation-program/rules.test.ts lib/managed-wealth/strategy-theme.test.ts`，通过（5/5）。
- 已执行 `openspec validate add-horus-participation-partner-program --strict --no-interactive`，通过。
- 8.2 集成测试交付：
  - 新增 `web/app/api/participation/account.integration.test.ts`，覆盖激活闸门（先注册后激活）、托管门槛校验、以及“直推奖励仅触发一次”链路。
  - 新增 `web/app/api/partners/partner-workflow.integration.test.ts`，覆盖月度淘汰、同月重复执行拦截、退款完成与完成后禁止失败回退。
- OpenSpec 任务更新：`8.2` 标记完成。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run --config vitest.config.ts app/api/participation/account.integration.test.ts app/api/partners/partner-workflow.integration.test.ts`，通过（3/3）。
- 已执行 `openspec validate add-horus-participation-partner-program --strict --no-interactive`，通过。
- 8.3 E2E 流程交付：
  - 新增 `web/e2e/participation-partner.spec.mjs`。
  - 覆盖场景 1：`FREE/MANAGED` 正式规则展示 + 托管申购门槛流（低于 500 失败，达标成功）。
  - 覆盖场景 2：合伙人席位操作流（淘汰 dry-run/execute + 退款完成）。
- 修复既有构建阻断问题：`web/lib/services/affiliate-engine.ts` 的 `../prisma.js` 无效导入已改为 `@/lib/prisma`，恢复 Next build 可用。
- OpenSpec 任务更新：`8.3` 标记完成。
- 已执行 `cd web && npx tsc --noEmit`，通过。
- 已执行 `cd web && npx vitest run --config vitest.config.ts lib/services/affiliate-engine.test.ts app/api/participation/account.integration.test.ts app/api/partners/partner-workflow.integration.test.ts`，通过（6/6）。
- 已执行 `cd web && npx playwright test --config=playwright.config.mjs e2e/participation-partner.spec.mjs`，通过（2/2）。
- 已执行 `openspec validate add-horus-participation-partner-program --strict --no-interactive`，通过。
