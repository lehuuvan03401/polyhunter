# Horus 托管理财功能设计（MVP 模拟盘）

- 日期：2026-02-14
- 作者：Codex（与产品方共创）
- 适用范围：`web`（产品/UI/API/Prisma）、复用现有 copy-trading 执行体系
- 设计状态：已确认，可进入实现规划

## 1. 背景与目标

当前系统已具备“AI 机器人模板 + 跟单执行”能力，但对非专业用户仍存在门槛：需要自己配置参数、理解交易细节、承担策略选择负担。

本设计新增“托管理财”产品层，让用户以“选产品”而不是“配交易”的方式参与：

1. 用户将资金委托给平台策略产品（独立资金仓，不混池）。
2. 用户选择机器人与策略档位（保守/稳健/激进）及期限（1天到1年）。
3. 平台在存续期内执行策略并展示净值与风险。
4. 到期执行收益分配与结算。

## 2. 已确认业务决策（来自需求澄清）

1. 资金形态：`用户独立资金仓`。
2. 产品期限：`混合模式`，支持 1/3/7/15/30/60/90/180/365 天。
3. 保底机制：
- 保守型可提供“保本保收益”；
- 稳健型、激进型不保底。
4. 保底兜底来源：`平台风险准备金`。
5. 明细可见性：`默认透明`（允许策略级延迟披露配置）。
6. 所有策略都进行利润分成，但比例可不同。
7. 首期版本：`MVP 模拟盘`（全流程可跑，不先动真实资金）。

## 3. 方案对比与选型

## 方案 A：产品层扩展（快）
在现有 `AgentTemplate + CopyTradingConfig + CopyTrade` 上新增托管产品层与结算层。

- 优点：复用度高，上线快。
- 缺点：长期复杂度累积。

## 方案 B：独立资管引擎（稳）
新建独立账户/份额/NAV/结算引擎，跟单系统仅做执行插件。

- 优点：边界清晰，长期扩展好。
- 缺点：首期投入大、迭代慢。

## 方案 C：混合演进（推荐）
一期按 A 快速上线，接口按 B 方式抽象，二期平滑迁移到独立引擎。

- 结论：采用 `方案 C`。

## 4. 产品定义

## 4.1 产品矩阵
每个托管产品由以下维度组成：

1. 策略档位：保守 / 稳健 / 激进。
2. 期限档位：1/3/7/15/30/60/90/180/365 天。
3. 预估收益区间：按“周期收益 + 折算年化”双展示。
4. 风险约束：最大回撤阈值 + 触发动作。
5. 收费规则：管理费（可选）+ 业绩分成（正收益计提）。
6. 保底规则：仅保守型可开启。
7. 披露规则：默认透明，可配置延迟披露。

## 4.2 用户体验主流程（MVP）

1. 用户进入“托管理财”页面筛选策略与期限。
2. 用户查看产品详情：目标收益、回撤、保底条款、分成比例。
3. 用户提交申购（模拟资金）。
4. 周期内查看净值曲线、成交明细、风控事件。
5. 到期自动结算，展示平台分成与用户净收益。
6. 用户下载/查看结算单与明细。

## 5. 业务规则设计

## 5.1 收益口径

1. 页面展示“目标收益区间（周期）”与“折算年化（估算）”。
2. 非保底产品必须提示“目标收益非承诺”。
3. 保底产品显示“最低收益线与触发条件”。

## 5.2 利润分成

1. 仅在净收益 > 0 时计提业绩分成。
2. 使用 `High-Water Mark`，仅对创新高收益部分计提，避免重复收费。
3. 策略级分成比例可配置（建议：保守 < 稳健 < 激进）。

## 5.3 保底规则（仅保守型）

1. 到期收益 >= 保底线：正常分成。
2. 到期收益 < 保底线：由风险准备金补差至保底线。
3. 提前赎回默认失去保底资格（避免套利）。
4. 当准备金覆盖率不足时，自动暂停保底产品新申购。

## 5.4 风控与回撤控制

每个“策略 x 期限”配置独立阈值，触发分级动作：

1. 一级：降仓位/降风险敞口。
2. 二级：暂停新开仓，仅允许减仓。
3. 三级：保护性平仓并锁定策略。

所有风控动作写入审计日志，供运营与合规追踪。

## 5.5 披露规则

1. 默认透明：持仓、成交、净值、回撤可见。
2. 可配置“延迟披露（N小时）”或“部分字段隐藏”。
3. 无论前台展示策略如何，后台风控与审计必须保留全量数据。

## 6. 系统架构（MVP）

## 6.1 逻辑分层

1. 产品层（新增）：托管产品定义、期限定义、条款配置。
2. 账户层（新增）：用户申购与独立仓生命周期。
3. 执行层（复用）：沿用 copy-trading 执行引擎。
4. 结算层（新增）：NAV、到期结算、分账、保底补差。
5. 披露层（新增）：对外展示策略控制。

## 6.2 与现有能力对接

1. `AgentTemplate`：作为产品可绑定的机器人模板。
2. `CopyTradingConfig`：作为申购后的执行配置实例。
3. `CopyTrade`：继续作为底层成交事实源。
4. `Guardrail` 相关服务：复用并扩展到产品级风险规则。

## 7. 数据模型（Prisma 建议新增）

## 7.1 新增模型

1. `ManagedProduct`
- 产品元信息：名称、策略级别、是否保底、状态、披露策略。

2. `ManagedTerm`
- 期限配置：天数、目标收益区间、最大回撤、分成比例、保底收益线。

3. `ManagedProductAgent`
- 产品与机器人模板关联（支持一对多、多对多扩展）。

4. `ManagedSubscription`
- 用户申购单：wallet、productId、termId、申购金额、起止时间、状态。

5. `ManagedNavSnapshot`
- 净值快照：nav、累计收益、回撤、波动、快照时间。

6. `ManagedSettlement`
- 到期结算：毛收益、分成金额、补差金额、净兑付、结算状态。

7. `ReserveFundLedger`
- 准备金账本：注资、占用、补差、回补、余额快照、审计字段。

8. `ManagedRiskEvent`
- 风控事件：触发阈值、动作、关联申购单、时间戳。

## 7.2 关系说明

1. `ManagedProduct` 1:N `ManagedTerm`。
2. `ManagedProduct` N:M `AgentTemplate`（经 `ManagedProductAgent`）。
3. `ManagedSubscription` 关联 `ManagedProduct` + `ManagedTerm` + 用户。
4. `ManagedSubscription` 可映射到执行层 `CopyTradingConfig`（每个申购独立）。
5. `ManagedSettlement` 1:1 `ManagedSubscription`（允许多次重算版本号）。

## 8. API 设计（MVP）

1. `GET /api/managed-products`
- 列表：策略、期限、目标收益、最大回撤、是否保底、状态。

2. `GET /api/managed-products/:id`
- 详情：条款、历史表现、分成、风控机制、披露规则。

3. `POST /api/managed-subscriptions`
- 创建申购：wallet、productId、termId、amount、风险确认。

4. `GET /api/managed-subscriptions?wallet=...`
- 用户申购列表：状态、剩余天数、当前 NAV、浮动收益。

5. `GET /api/managed-subscriptions/:id/nav`
- 净值曲线、回撤、波动、风险事件。

6. `POST /api/managed-settlement/run`
- 结算任务入口（cron/手动）。

7. `GET /api/managed-settlements/:subscriptionId`
- 结算结果与分账明细。

8. `GET /api/reserve-fund/summary`（管理端）
- 准备金余额、占用、覆盖率、风险敞口。

## 9. 前端信息架构（MVP）

1. 新增一级入口：`托管理财`。
2. 页面：产品列表页（筛选 + 卡片）。
3. 页面：产品详情页（条款 + 历史 + 风险 + 申购）。
4. 页面：我的托管（持仓 + 净值 + 到期进度 + 明细）。
5. 管理页：产品参数与准备金监控（内部使用）。

## 10. 数据流与任务流

## 10.1 申购流

1. 用户提交申购。
2. 创建 `ManagedSubscription`。
3. 按产品映射生成/关联执行配置。
4. 进入运行中状态，开始净值快照任务。

## 10.2 日内更新流

1. 执行层产生 `CopyTrade`。
2. NAV 计算任务更新 `ManagedNavSnapshot`。
3. 风控任务检查回撤阈值并触发动作。
4. 披露层按策略决定前台展示延迟与粒度。

## 10.3 到期结算流

1. 到期扫描任务识别需结算申购。
2. 计算毛收益与高水位分成。
3. 若保守型且低于保底线：写 `ReserveFundLedger` 补差。
4. 写入 `ManagedSettlement`，更新申购状态为已结算。

## 11. 异常处理与降级策略

1. 执行失败：记录失败原因，重试或跳过，NAV 按已成交事实更新。
2. 行情异常：启用备用价格源并打标“估值延迟”。
3. 准备金不足：自动下线保底产品申购入口。
4. 任务重入：结算任务使用幂等键，防止重复结算。
5. 披露异常：回退到更透明策略，避免误隐藏。

## 12. 测试与验收

## 12.1 单元测试

1. 分成计算与高水位逻辑。
2. 保底补差计算。
3. 期限收益折算与展示计算。
4. 提前赎回与保底失效逻辑。

## 12.2 集成测试

1. 申购 -> 存续 -> 到期结算全链路。
2. 保守型触发补差路径。
3. 稳健/激进不保底路径。
4. 风控触发与状态变更路径。

## 12.3 E2E 测试

1. 用户完成产品筛选与申购。
2. 用户查看净值与明细。
3. 到期查看结算单与分账。

## 13. 发布策略（MVP）

1. 仅模拟盘环境开启。
2. 采用 feature flag 控制入口与 API。
3. 先灰度给内部账号/白名单。
4. 跑满一个结算周期后再进入真实资金方案设计。

## 14. 非目标（MVP 不做）

1. 真实资金链上托管与法币/稳定币清结算。
2. 多策略自动再平衡与组合优化器。
3. 第三方保险对接。
4. 跨产品资金调拨。

## 15. 风险与待决事项

1. 保底产品在不同市场波动下的准备金覆盖率模型需单独审计。
2. 目标收益展示文案需明确“预估”与“承诺”边界，避免误导。
3. 从模拟盘迁移真实资金前，需补充合规、托管与清算方案。

## 16. 实施建议（下一步）

1. 先提交 OpenSpec 变更提案（新增 capability：`managed-wealth`）。
2. 生成实现任务清单：DB -> API -> 任务流 -> 前端页面 -> 测试。
3. 以 30 天保守型产品作为第一条 E2E 跑通样例。
