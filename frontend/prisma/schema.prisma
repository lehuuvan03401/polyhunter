// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Affiliate tier levels
enum AffiliateTier {
  BRONZE
  SILVER
  GOLD
  DIAMOND
}

// Payout status
enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Referrer - wallet registered as affiliate
model Referrer {
  id            String        @id @default(cuid())
  walletAddress String        @unique
  referralCode  String        @unique
  tier          AffiliateTier @default(BRONZE)
  totalVolume   Float         @default(0)
  totalEarned   Float         @default(0)
  pendingPayout Float         @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  referrals     Referral[]
  payouts       Payout[]
  volumeRecords ReferralVolume[]
}

// Referral - user referred by an affiliate
model Referral {
  id             String   @id @default(cuid())
  referrer       Referrer @relation(fields: [referrerId], references: [id])
  referrerId     String
  refereeAddress String   @unique
  lifetimeVolume Float    @default(0)
  last30DaysVolume Float  @default(0)
  createdAt      DateTime @default(now())
  lastActiveAt   DateTime?

  @@index([referrerId])
}

// Daily volume aggregation
model ReferralVolume {
  id           String   @id @default(cuid())
  referrer     Referrer @relation(fields: [referrerId], references: [id])
  referrerId   String
  date         DateTime
  volumeUsd    Float    @default(0)
  commissionUsd Float   @default(0)
  tradeCount   Int      @default(0)

  @@unique([referrerId, date])
  @@index([referrerId])
}

// Payout records
model Payout {
  id          String       @id @default(cuid())
  referrer    Referrer     @relation(fields: [referrerId], references: [id])
  referrerId  String
  amountUsd   Float
  status      PayoutStatus @default(PENDING)
  txHash      String?
  createdAt   DateTime     @default(now())
  processedAt DateTime?
  errorMessage String?

  @@index([referrerId])
}

// ========================================
// Proxy System Models
// ========================================

// Subscription tier levels (determines fee percentage)
enum SubscriptionTier {
  STARTER  // 10% fee
  PRO      // 5% fee
  WHALE    // 2% fee
}

// User's trading proxy wallet
model UserProxy {
  id              String           @id @default(cuid())
  walletAddress   String           @unique  // User's main wallet
  proxyAddress    String           @unique  // Smart contract proxy address
  tier            SubscriptionTier @default(STARTER)
  totalDeposited  Float            @default(0)
  totalWithdrawn  Float            @default(0)
  totalVolume     Float            @default(0)
  totalProfit     Float            @default(0)
  totalFeesPaid   Float            @default(0)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  feeTransactions FeeTransaction[]

  @@index([walletAddress])
}

// Fee transaction records
model FeeTransaction {
  id           String    @id @default(cuid())
  userProxy    UserProxy @relation(fields: [userProxyId], references: [id])
  userProxyId  String
  profitAmount Float     // Profit amount that triggered the fee
  feeAmount    Float     // Fee collected
  feePercent   Float     // Fee percentage at time of transaction (10, 5, 2)
  txHash       String?   // On-chain transaction hash
  blockNumber  Int?      // Block number of the transaction
  createdAt    DateTime  @default(now())

  @@index([userProxyId])
  @@index([createdAt])
}
