// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Affiliate tier levels
// Affiliate tier levels (5-level rank system)
enum AffiliateTier {
  ORDINARY // Level 1
  VIP // Level 2 (Direct: 3, Team: 10)
  ELITE // Level 3 (Direct: 10, Team: 100)
  PARTNER // Level 4 (Direct: 30, Team: 500)
  SUPER_PARTNER // Level 5 (Direct: 50, Team: 1000)
}

// Payout status
enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REJECTED
}

// Referrer - wallet registered as affiliate
model Referrer {
  id            String        @id @default(cuid())
  walletAddress String        @unique
  referralCode  String        @unique
  tier          AffiliateTier @default(ORDINARY)
  totalVolume   Float         @default(0)
  totalEarned   Float         @default(0)
  pendingPayout Float         @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  referrals     Referral[]
  payouts       Payout[]
  volumeRecords ReferralVolume[]

  // MLM Hierarchy (Closure Table)
  ancestors   TeamClosure[] @relation("DescendantRelation")
  descendants TeamClosure[] @relation("AncestorRelation")

  // Performance Metrics
  maxDepth       Int             @default(0) // Deepest level of the team
  sunLineCount   Int             @default(0) // Number of qualified sun lines
  teamVolume     Float           @default(0) // Total volume of the subtree
  commissionLogs CommissionLog[]
}

// Closure Table for efficient tree traversal
model TeamClosure {
  id String @id @default(cuid())

  ancestor   Referrer @relation("AncestorRelation", fields: [ancestorId], references: [id])
  ancestorId String

  descendant   Referrer @relation("DescendantRelation", fields: [descendantId], references: [id])
  descendantId String

  depth Int // 0 = self, 1 = direct, 2 = grand-child, etc.

  @@unique([ancestorId, descendantId])
  @@index([ancestorId])
  @@index([descendantId])
}

// Referral - user referred by an affiliate
model Referral {
  id               String    @id @default(cuid())
  referrer         Referrer  @relation(fields: [referrerId], references: [id])
  referrerId       String
  refereeAddress   String    @unique
  lifetimeVolume   Float     @default(0)
  last30DaysVolume Float     @default(0)
  createdAt        DateTime  @default(now())
  lastActiveAt     DateTime?

  @@index([referrerId])
}

// Daily volume aggregation
model ReferralVolume {
  id            String   @id @default(cuid())
  referrer      Referrer @relation(fields: [referrerId], references: [id])
  referrerId    String
  date          DateTime
  volumeUsd     Float    @default(0)
  commissionUsd Float    @default(0)
  tradeCount    Int      @default(0)

  @@unique([referrerId, date])
  @@index([referrerId])
}

// Payout records
model Payout {
  id           String       @id @default(cuid())
  referrer     Referrer     @relation(fields: [referrerId], references: [id])
  referrerId   String
  amountUsd    Float
  status       PayoutStatus @default(PENDING)
  txHash       String?
  createdAt    DateTime     @default(now())
  processedAt  DateTime?
  errorMessage String?

  @@index([referrerId])
}

// Detailed commission ledger
model CommissionLog {
  id            String   @id @default(cuid())
  referrer      Referrer @relation(fields: [referrerId], references: [id])
  referrerId    String
  amount        Float
  type          String // 'ZERO_LINE' | 'SUN_LINE'
  sourceTradeId String? // ID of the trade that generated this
  sourceUserId  String? // Wallet address of the user who traded
  generation    Int? // For Zero Line: which generation (1-5)?
  createdAt     DateTime @default(now())

  @@index([referrerId])
  @@index([type])
  @@index([createdAt])
}

// ========================================
// Proxy System Models
// ========================================

// Subscription tier levels (determines fee percentage)
enum SubscriptionTier {
  STARTER // 10% fee
  PRO // 5% fee
  WHALE // 2% fee
}

// User's trading proxy wallet
model UserProxy {
  id             String           @id @default(cuid())
  walletAddress  String           @unique // User's main wallet
  proxyAddress   String           @unique // Smart contract proxy address
  tier           SubscriptionTier @default(STARTER)
  totalDeposited Float            @default(0)
  totalWithdrawn Float            @default(0)
  totalVolume    Float            @default(0)
  totalProfit    Float            @default(0)
  totalFeesPaid  Float            @default(0)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  feeTransactions FeeTransaction[]
  transactions    ProxyTransaction[]

  @@index([walletAddress])
}

// Proxy financial transactions (Deposit/Withdraw)
model ProxyTransaction {
  id          String    @id @default(cuid())
  userProxy   UserProxy @relation(fields: [userProxyId], references: [id])
  userProxyId String
  type        String // 'DEPOSIT' | 'WITHDRAW'
  amount      Float
  txHash      String?
  status      String    @default("COMPLETED") // 'PENDING' | 'COMPLETED' | 'FAILED'
  createdAt   DateTime  @default(now())

  @@index([userProxyId])
  @@index([type])
  @@index([createdAt])
}

// Fee transaction records
model FeeTransaction {
  id           String    @id @default(cuid())
  userProxy    UserProxy @relation(fields: [userProxyId], references: [id])
  userProxyId  String
  profitAmount Float // Profit amount that triggered the fee
  feeAmount    Float // Fee collected
  feePercent   Float // Fee percentage at time of transaction (10, 5, 2)
  txHash       String? // On-chain transaction hash
  blockNumber  Int? // Block number of the transaction
  createdAt    DateTime  @default(now())

  @@index([userProxyId])
  @@index([createdAt])
}

// ========================================
// Copy Trading Models
// ========================================

// Copy trading mode
enum CopyTradingMode {
  PERCENTAGE // Copy X% of trader's position
  FIXED_AMOUNT // Fixed dollar amount per trade
}

// Strategy Profile - Controls slippage, size, and risk parameters
enum StrategyProfile {
  CONSERVATIVE // Low slippage (0.5%), tight stop loss
  MODERATE // Standard slippage (1%), medium risk
  AGGRESSIVE // High slippage (5%), high risk
}

// Trade size interpretation
enum TradeSizeMode {
  SHARES // Trade size represents shares
  NOTIONAL // Trade size represents USDC notional
}

// Execution mode
enum ExecutionMode {
  PROXY // Default: Use Smart Contract Proxy (Non-Custodial)
  EOA // Fast: Use Hosted Private Key (Custodial)
}

// Copy trade execution status
enum CopyTradeStatus {
  PENDING // Waiting for user confirmation
  EXECUTED // Successfully executed (Fully settled)
  SETTLEMENT_PENDING // Executed but Funds/Tokens not returned to Proxy yet
  FAILED // Execution failed
  SKIPPED // Skipped due to filters/conditions
  EXPIRED // User didn't confirm in time
}

// User's copy trading configuration
model CopyTradingConfig {
  id            String  @id @default(cuid())
  walletAddress String // User's wallet address
  traderAddress String // Trader being copied
  traderName    String? // Display name of trader

  // Strategy Profile
  strategyProfile StrategyProfile @default(MODERATE)
  tradeSizeMode TradeSizeMode @default(SHARES)

  // Slippage settings
  slippageType String @default("FIXED") // 'FIXED' | 'AUTO'
  maxSlippage  Float  @default(2.0) // Max slippage % (default 2%)

  // Execution settings
  autoExecute Boolean @default(false) // If true, executes immediately via worker
  channel     String  @default("POLLING") // 'POLLING' | 'EVENT_LISTENER'

  // Execution Mode Settings
  executionMode ExecutionMode @default(PROXY)
  encryptedKey  String? // For EOA mode (Encrypted Private Key)
  iv            String? // Initialization Vector for decryption

  // Copy mode settings
  mode            CopyTradingMode @default(PERCENTAGE)
  sizeScale       Float? // For PERCENTAGE mode: 0.5 = 50%
  fixedAmount     Float? // For FIXED_AMOUNT mode
  maxSizePerTrade Float           @default(100)
  minSizePerTrade Float? // For RANGE mode: minimum $ per trade

  // Advanced mode settings
  infiniteMode Boolean @default(false) // Pause and retry on insufficient funds
  takeProfit   Float? // Auto-pause at this profit ($)
  stopLoss     Float? // Auto-pause at this loss ($)
  direction    String  @default("COPY") // 'COPY' | 'COUNTER'

  // Filters - basic
  sideFilter     String? // 'BUY' | 'SELL' | null (both)
  minTriggerSize Float? // Min trade size to trigger copy ($)
  maxDaysOut     Int? // Max market expiry days

  // Filters - advanced
  maxPerMarket Float? // Max total investment per market ($)
  minLiquidity Float? // Min market liquidity ($)
  minVolume    Float? // Min market volume ($)
  maxOdds      Float? // Max odds to copy (e.g., 0.8 = 80%)

  // Sell strategy
  sellMode        String @default("SAME_PERCENT") // 'SAME_PERCENT' | 'FIXED_AMOUNT' | 'CUSTOM_PERCENT'
  sellFixedAmount Float? // For FIXED_AMOUNT sell mode ($)
  sellPercentage  Float? // For CUSTOM_PERCENT sell mode (0.25 = 25%)

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  copyTrades CopyTrade[]

  @@index([walletAddress])
  @@index([traderAddress])
  @@index([isActive])
}

// Individual copy trade record
model CopyTrade {
  id       String            @id @default(cuid())
  config   CopyTradingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  configId String
  idempotencyKey String @unique @default(cuid())

  // Original trade info
  originalTrader String
  originalSide   String // 'BUY' | 'SELL'
  leaderSide     String? // Leader's original side (for COUNTER mode auditing)
  originalSize   Float
  originalPrice  Float
  marketSlug     String?
  originalTxHash String? // Leader's transaction hash
  conditionId    String?
  tokenId        String?
  outcome        String? // 'Yes' | 'No'

  // Copy trade info
  copySize  Float
  copyPrice Float?

  // Execution status
  status       CopyTradeStatus @default(PENDING)
  txHash       String?
  errorMessage String?
  realizedPnL  Float? // Profit/Loss for SELL trades (calculated by PositionService)
  usedBotFloat Boolean         @default(false)

  // Timestamps
  detectedAt DateTime  @default(now())
  executedAt DateTime?
  expiresAt  DateTime? // For PENDING trades

  @@index([configId])
  @@index([status])
  @@index([detectedAt])
  @@unique([configId, originalTxHash])
}

// Sync log for tracking sync history
model SyncLog {
  id          String    @id @default(cuid())
  type        String // 'PROXY_STATS' | 'COPY_TRADING_DETECT'
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  synced      Int       @default(0)
  failed      Int       @default(0)
  durationMs  Int?
  errors      String? // JSON array of error messages

  @@index([type])
  @@index([startedAt])
}

// Debt Record for tracking failed reimbursements
model DebtRecord {
  id           String    @id @default(cuid())
  proxyAddress String
  botAddress   String
  amount       Float
  currency     String // e.g. "USDC" or Token Address
  status       String // "PENDING", "REPAID"
  errorLog     String?
  createdAt    DateTime  @default(now())
  repaidAt     DateTime?

  @@index([proxyAddress])
  @@index([botAddress])
  @@index([status])
}

// ========================================
// Profit-Based Fee System Models
// ========================================

// User's position for a specific token (for Cost Basis / Profit Calculation)
model UserPosition {
  id            String   @id @default(cuid())
  walletAddress String // Follower's wallet
  tokenId       String // Polymarket Token ID
  balance       Float    @default(0) // Current share balance
  avgEntryPrice Float    @default(0) // Weighted Average Entry Price (USDC)
  totalCost     Float    @default(0) // Total cost spent (for verification)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([walletAddress, tokenId])
  @@index([walletAddress])
}

// Volume-Based Fee Tier Configuration
model VolumeTier {
  id              String @id @default(cuid())
  minVolume       Float // Minimum cumulative volume to qualify
  maxVolume       Float? // Maximum volume (null = infinity)
  feeRateOnProfit Float // Fee rate as a decimal (0.20 = 20%)
  name            String // "Standard", "Pro", "Whale"
}

model CachedSmartMoney {
  id         String   @id @default(cuid())
  page       Int
  rank       Int
  traderData Json // Full SmartMoneyWallet object
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([page, rank])
  @@index([page])
}

model SmartMoneyCacheMeta {
  id           String   @id @default(cuid())
  lastUpdateAt DateTime
  status       String // "SUCCESS", "FAILED", "IN_PROGRESS"
  traderCount  Int?
  errorMessage String?
  updatedAt    DateTime @updatedAt
}

// ========================================
// Trader Leaderboard Caching
// ========================================

// Cached trader leaderboard entries
model CachedTraderLeaderboard {
  id         String   @id @default(cuid())
  period     String // "7d", "15d", "30d", "90d"
  rank       Int
  traderData Json // Full ActiveTrader object from /api/traders/active
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([period, rank])
  @@index([period])
}

// Metadata tracking cache update status
model LeaderboardCacheMeta {
  id           String   @id @default(cuid())
  period       String   @unique
  lastUpdateAt DateTime
  status       String // "SUCCESS", "FAILED", "IN_PROGRESS"
  traderCount  Int?
  errorMessage String?
  updatedAt    DateTime @updatedAt
}
